-- 1) Activer RLS sur la table
ALTER TABLE documents ENABLE ROW LEVEL SECURITY;

-- 2) Politique : tous les utilisateurs authentifiés peuvent SELECT (lire/télécharger)
CREATE POLICY "authenticated_can_select_documents" ON documents
  FOR SELECT
  TO authenticated
  USING (true);

-- 3) Politique : seuls les admins peuvent INSERT
CREATE POLICY "admins_can_insert_documents" ON documents
  FOR INSERT
  TO authenticated
  WITH CHECK (
    (auth.jwt() -> 'user_metadata' ->> 'is_admin')::boolean = true
  );

-- 4) Politique : seuls les admins peuvent UPDATE
CREATE POLICY "admins_can_update_documents" ON documents
  FOR UPDATE
  TO authenticated
  USING (
    (auth.jwt() -> 'user_metadata' ->> 'is_admin')::boolean = true
  )
  WITH CHECK (
    (auth.jwt() -> 'user_metadata' ->> 'is_admin')::boolean = true
  );

-- 5) Politique : seuls les admins peuvent DELETE
CREATE POLICY "admins_can_delete_documents" ON documents
  FOR DELETE
  TO authenticated
  USING (
    (auth.jwt() -> 'user_metadata' ->> 'is_admin')::boolean = true
  );
